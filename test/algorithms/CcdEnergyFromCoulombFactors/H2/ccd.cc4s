CoulombVertexReader [
  (file "../../../resources/CoulombVertexH2.bin")
] [
  CoulombVertex HoleEigenEnergies ParticleEigenEnergies
].

CoulombIntegralsFromVertex [
  CoulombVertex
  HoleEigenEnergies ParticleEigenEnergies
] [
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  PPPPCoulombIntegrals
].

% Compute the CcdEnergy from the integrals
CcdEnergyFromCoulombIntegrals [
  PPPPCoulombIntegrals
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  ParticleEigenEnergies HoleEigenEnergies
  % Sets maximum iterations. Default is 16.
  (maxIterations 16)
] [
  (CcdEnergy CcdEnergy) 
  (CcdDoublesAmplitudes CcdDoublesAmplitudes)
].

TensorWriter [(Data CcdEnergy)] [].

% Compute the CcdEnergy from the integrals using slicing
CcdEnergyFromSlicedIntegrals [
  CoulombVertex
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  ParticleEigenEnergies HoleEigenEnergies
  % Sets maximum iterations. Default is 16.
  (maxIterations 16)
  % Set the slice rank of PPPPCoulombIntegrals. Default is No.
  (sliceRank 28)
] [
  (CcdEnergy CcdEnergySlice)
  (CcdDoublesAmplitudes CcdDoublesAmplitudes)
].

TensorWriter [(Data CcdEnergySlice)] [].

SliceCoulombVertex [
  CoulombVertex HoleEigenEnergies ParticleEigenEnergies
] [
  ParticleHoleCoulombVertex
].

ParticleHoleCoulombIntegrals [
  ParticleHoleCoulombVertex
] [
  PPHHCoulombIntegrals
].

% compute EnergyMatrix from direct term only (only negative eigenvalues)
DrccdEnergyFromCoulombVertex [
  PPHHCoulombIntegrals
  ParticleHoleCoulombVertex
  HoleEigenEnergies ParticleEigenEnergies
  % just calculate direct MP2
  (maxIterations 1)
] [
  DrccdEnergy
  DrccdDoublesAmplitudes
].

EnergyMatrixFromDoublesAmplitudes [
  ParticleHoleCoulombVertex
  (DoublesAmplitudes DrccdDoublesAmplitudes)
] [
  EnergyMatrix
].
%%%%%%%%%%%%%%%

ReduceEnergyMatrix [
  EnergyMatrix
  (reduction 0.5)
] [
  EnergyMatrixTransform
].

ReduceCoulombVertex [
  CoulombVertex
  EnergyMatrixTransform
] [
  ReducedCoulombVertex
].

CoulombVertexDecomposition [
  (CoulombVertex ReducedCoulombVertex)
  % Set the rank of the decomposed tensor and the number of iterations.
  % Default rank is NG, and default number of iterattions is 32.
  (rank 2070) (maxIterations 32)
  % the LinearMixer is used by default
  (mixer "LinearMixer")
  (mixingRatio 0.8)
] [
  FactorOrbitals CoulombFactors
  % Returns (if given) the Coulomb Vertex from the decomposed tensors.
  ComposedCoulombVertex
].

CoulombIntegralsFromVertex [
  % Compute the Coulomb integrals from the composed vertex
  % rather than from the original one, for comparability
  (CoulombVertex ReducedCoulombVertex)
  HoleEigenEnergies ParticleEigenEnergies
] [
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  PPPPCoulombIntegrals
].

% Compute the CcdEnergy from the integrals
CcdEnergyFromCoulombIntegrals [
  PPPPCoulombIntegrals
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  ParticleEigenEnergies HoleEigenEnergies
  % Sets maximum iterations. Default is 16.
  (maxIterations 16)
] [
  (CcdEnergy CcdEnergyReduce)
  (CcdDoublesAmplitudes CcdDoublesAmplitudes)
].

TensorWriter [(Data CcdEnergyReduce)] [].

% Compute the CcdEnergy from the integrals using slicing
CcdEnergyFromSlicedIntegrals [
  % For slicing use the composed vertex
  % rather than from the original one, for comparability
  (CoulombVertex ReducedCoulombVertex)
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  ParticleEigenEnergies HoleEigenEnergies
  % Sets maximum iterations. Default is 16.
  (maxIterations 16)
  % Uncomment next line to set the slice rank of PPPPCoulombIntegrals. Default is No.
  (sliceRank 28)
] [
  (CcdEnergy CcdEnergySliceReduce)
  (CcdDoublesAmplitudes CcdDoublesAmplitudes)
].

TensorWriter [(Data CcdEnergySliceReduce)] [].

CoulombIntegralsFromVertex [
  % Compute the Coulomb integrals from the composed vertex
  % rather than from the original one, for comparability
  (CoulombVertex ComposedCoulombVertex)
% CoulombVertex
  HoleEigenEnergies ParticleEigenEnergies
] [
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  PPPPCoulombIntegrals
].

% Compute the CcdEnergy from the integrals
CcdEnergyFromCoulombIntegrals [
  PPPPCoulombIntegrals
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  ParticleEigenEnergies HoleEigenEnergies
  % Sets maximum iterations. Default is 16.
  (maxIterations 16)
] [
  (CcdEnergy CcdEnergyReduceTRD)
  (CcdDoublesAmplitudes CcdDoublesAmplitudes)
].

TensorWriter [(Data CcdEnergyReduceTRD)] [].

% Compute the CcdEnergy from the integrals using slicing
CcdEnergyFromSlicedIntegrals [
  % For slicing use the composed vertex
  % rather than from the original one, for comparability
  (CoulombVertex ComposedCoulombVertex)
% CoulombVertex
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  ParticleEigenEnergies HoleEigenEnergies
  % Sets maximum iterations. Default is 16.
  (maxIterations 16)
  % Uncomment next line to set the slice rank of PPPPCoulombIntegrals. Default is No.
  (sliceRank 28)
] [
  (CcdEnergy CcdEnergySliceReduceTRD)
  (CcdDoublesAmplitudes CcdDoublesAmplitudes)
].

TensorWriter [(Data CcdEnergySliceReduceTRD)] [].

% Compute the CcdEnergy from the Coulomb factors
CcdEnergyFromCoulombFactors [
  % Coulomb factors are used when necessary for low memory and O(N^5)
  FactorOrbitals CoulombFactors
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  ParticleEigenEnergies HoleEigenEnergies
  % Sets maximum iterations. Default is 16.
  (maxIterations 16)
  % the LinearMixer is used by default
% (mixer "LinearMixer")
% (mixingRatio 1.5)
] [
  (CcdEnergy CcdEnergyFactorsReduceTRD)
  (CcdDoublesAmplitudes CcdDoublesAmplitudesFactors)
].

TensorWriter [(Data CcdEnergyFactorsReduceTRD)] [].
