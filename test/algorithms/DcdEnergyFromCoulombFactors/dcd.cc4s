CoulombVertexReader [
  (file "../../resources/CoulombVertex.bin")
] [
  CoulombVertex HoleEigenEnergies ParticleEigenEnergies
].

CoulombVertexDecomposition [
  CoulombVertex
  (rank 66) (maxIterations 20)
] [
  FactorOrbitals CoulombFactors
  ComposedCoulombVertex
].

CcdCoulombIntegrals [
  % compute the Coulomb integratls from the composed vertex
  % rather than from the original one, for comparability
  (CoulombVertex ComposedCoulombVertex)
%  CoulombVertex
  HoleEigenEnergies ParticleEigenEnergies
] [
  PPPPCoulombIntegrals PHPHCoulombIntegrals PHHPCoulombIntegrals
  PPHHCoulombIntegrals HHHHCoulombIntegrals
].

% compute the DcdEnergy once from the integrals using slicing
DcdEnergyFromCoulombIntegrals [
%  PPPPCoulombIntegrals
  (CoulombVertex ComposedCoulombVertex)
  PHPHCoulombIntegrals PHHPCoulombIntegrals 
  PPHHCoulombIntegrals HHHHCoulombIntegrals
  HoleEigenEnergies ParticleEigenEnergies
  (maxIterations 2)
] [
  DcdEnergy DcdDoublesAmplitudes
].

TensorWriter [(Data DcdEnergy)] [].

% and once from the factors
DcdEnergyFromCoulombFactors [
  % the factors are used for when necessary for low memory and O(N^5)
  FactorOrbitals CoulombFactors
  % the Coulomb vertex is directly used where possible
  CoulombVertex
  HoleEigenEnergies ParticleEigenEnergies
  % where memory is not a concern, the integrals are used
  PHPHCoulombIntegrals PHHPCoulombIntegrals
  PPHHCoulombIntegrals HHHHCoulombIntegrals
  (maxIterations 2)
  % the TrivialMixer is used by default
%  (mixer "TrivialMixer")
%  (mixingRatio 1.5)
] [
  (DcdEnergy DcdEnergyFromFactors)
  (DcdDoublesAmplitudes DcdDoublesAmplitudesFromFactors)
].

TensorWriter [(Data DcdEnergyFromFactors)] [].

