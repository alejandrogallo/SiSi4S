CoulombVertexReader [
  (file "../../resources/CoulombVertex.bin")
] [
  CoulombVertex HoleEigenEnergies ParticleEigenEnergies
].

CoulombVertexDecomposition [
  CoulombVertex
  % Set the rank of the decomposed tensor and the number of iterations.
  (rank 66) (maxIterations 32)
  % the LinearMixer is used by default
  (mixer "LinearMixer")
  (mixingRatio 0.8)
] [
  FactorOrbitals CoulombFactors
  % Returns (if given) the Coulomb Vertex from the decomposed tensors.
  ComposedCoulombVertex
].

CoulombIntegralsFromVertex [
  % Compute the Coulomb integrals from the composed vertex
  % rather than from the original one, for comparability
  (CoulombVertex ComposedCoulombVertex)
% CoulombVertex
  HoleEigenEnergies ParticleEigenEnergies
] [
  PPPPCoulombIntegrals
  PPPHCoulombIntegrals
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  HHHPCoulombIntegrals
].

DcsdEnergyFromCoulombIntegrals [
  CoulombVertex
  PPPPCoulombIntegrals
  PPPHCoulombIntegrals
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  HHHPCoulombIntegrals
  ParticleEigenEnergies HoleEigenEnergies
  % Sets maximum iterations. Default is 16.
  (maxIterations 64)
] [
  (DcsdEnergy DcsdEnergy) 
  (DcsdSinglesAmplitudes DcsdSinglesAmplitudes)
  (DcsdDoublesAmplitudes DcsdDoublesAmplitudes)
].

TensorWriter [(Data DcsdEnergy)] [].

% Compute the DcsdEnergy from the integrals using slicing
DcsdEnergyFromSlicedIntegrals [
  % For slicing use the composed vertex
  % rather than from the original one, for comparability
  (CoulombVertex ComposedCoulombVertex)
% CoulombVertex
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  HHHPCoulombIntegrals
  ParticleEigenEnergies HoleEigenEnergies
  % Sets maximum iterations. Default is 16.
  (maxIterations 64)
  % Uncomment next line to set the slice rank of PPPPCoulombIntegrals. Default is No.
  (sliceRank 13)
] [
  (DcsdEnergy DcsdEnergySlice) 
  (DcsdSinglesAmplitudes DcsdSinglesAmplitudes)
  (DcsdDoublesAmplitudes DcsdDoublesAmplitudes)
].

TensorWriter [(Data DcsdEnergySlice)] [].

% Compute the DcsdEnergy from the Coulomb factors
DcsdEnergyFromCoulombFactors [
  % Coulomb vertex and factors are used when necessary for low memory and O(N^5)
  (CoulombVertex ComposedCoulombVertex)
  FactorOrbitals CoulombFactors
  PHPHCoulombIntegrals
  PPHHCoulombIntegrals
  HHHHCoulombIntegrals
  HHHPCoulombIntegrals
  ParticleEigenEnergies HoleEigenEnergies
  % Sets maximum iterations. Default is 16.
  (maxIterations 64)
  % the LinearMixer is used by default
% (mixer "LinearMixer")
% (mixingRatio 1.5)
] [
  (DcsdEnergy DcsdEnergyFactors)
  (DcsdSinglesAmplitudes DcsdSinglesAmplitudesFactors)
  (DcsdDoublesAmplitudes DcsdDoublesAmplitudesFactors)
].

TensorWriter [(Data DcsdEnergyFactors)] [].
