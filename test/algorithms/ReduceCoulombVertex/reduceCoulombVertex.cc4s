CoulombVertexReader [
  (file "../../resources/CoulombVertex.bin")
] [
  CoulombVertex HoleEigenEnergies ParticleEigenEnergies
].

SliceCoulombVertex [
  CoulombVertex HoleEigenEnergies ParticleEigenEnergies
] [
  ParticleHoleCoulombVertex
].

ParticleHoleCoulombIntegrals [
  ParticleHoleCoulombVertex
] [
  PPHHCoulombIntegrals
].

Mp2EnergyFromCoulombIntegrals [
  PPHHCoulombIntegrals
  HoleEigenEnergies ParticleEigenEnergies
] [
  Mp2Energy 
].

%%%%%%%%%%%%%%%
% compute EnergyMatrix from direct term only (only negative eigenvalues)
DrccdEnergyFromCoulombVertex [
  PPHHCoulombIntegrals
  ParticleHoleCoulombVertex
  HoleEigenEnergies ParticleEigenEnergies
  % just calculate direct MP2
  (maxIterations 1)
] [
  DrccdEnergy
  DrccdDoublesAmplitudes
].

EnergyMatrixFromDoublesAmplitudes [
  ParticleHoleCoulombVertex
  (DoublesAmplitudes DrccdDoublesAmplitudes)
] [
  EnergyMatrix
].
%%%%%%%%%%%%%%%

%%%%%%%%%%%%%%%
% compute EnergyMatrix from direct & exchange term (also positive eigenvalues)
%Mp2EnergyMatrixFromCoulombIntegrals [
%  ParticleHoleCoulombVertex
%  PPHHCoulombIntegrals
%  HoleEigenEnergies ParticleEigenEnergies
%] [
%  (Mp2EnergyMatrix EnergyMatrix)
%].
%%%%%%%%%%%%%%%

ReduceEnergyMatrix [
  EnergyMatrix
  (reduction 0.5)
] [
  EnergyMatrixTransform
].

ReduceParticleHoleCoulombVertex [
  ParticleHoleCoulombVertex
  EnergyMatrixTransform
] [
  ReducedParticleHoleCoulombVertex
].

ParticleHoleCoulombIntegrals [
  (ParticleHoleCoulombVertex ReducedParticleHoleCoulombVertex)
] [
  (PPHHCoulombIntegrals ReducedPPHHCoulombIntegrals)
].

Mp2EnergyFromCoulombIntegrals [
  (PPHHCoulombIntegrals ReducedPPHHCoulombIntegrals)
  HoleEigenEnergies ParticleEigenEnergies
] [
  (Mp2Energy ReducedMp2Energy)
].


%
ReduceCoulombVertex [
  CoulombVertex
  EnergyMatrixTransform
] [
  ReducedCoulombVertex
].

CoulombVertexDecomposition [
  (CoulombVertex ReducedCoulombVertex)
  (rank 100)
  (maxIterations 64)
  (mixingRatio 0.8)
] [
  FactorOrbitals CoulombFactors
  % approximation from the rank decomposition:
  ComposedCoulombVertex
].

SliceCoulombVertex [
  (CoulombVertex ComposedCoulombVertex)
  HoleEigenEnergies ParticleEigenEnergies
] [
  (ParticleHoleCoulombVertex ComposedParticleHoleCoulombVertex)
].

ParticleHoleCoulombIntegrals [
  (ParticleHoleCoulombVertex ComposedParticleHoleCoulombVertex)
  HoleEigenEnergies ParticleEigenEnergies
] [
  (PPHHCoulombIntegrals ComposedPPHHCoulombIntegrals)
].

Mp2EnergyFromCoulombIntegrals [
  (PPHHCoulombIntegrals ComposedPPHHCoulombIntegrals)
  HoleEigenEnergies ParticleEigenEnergies
] [
  (Mp2Energy ComposedMp2Energy)
].

TensorWriter [(Data ComposedMp2Energy)] [].

TensorWriter [(Data Mp2Energy)] [].
TensorWriter [(Data ReducedMp2Energy)] [].
